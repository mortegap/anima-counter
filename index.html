<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-form/0.3.1/vue-form.js"></script>
    <link rel="icon" type="image/x-icon" href="images/spellbook.png">
    <title>Zeon Counter</title>

    <style>
        [v-cloak] {
            display: none !important;
        }
        .vue-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .auth-container {
            min-height: 100vh;
            display: flex !important;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(25px);
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        /* Override any parent container styles for auth pages */
        .auth-mode {
            display: block !important;
            position: relative;
            margin: 0 !important;
            padding: 0 !important;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .auth-card .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            border: none;
            padding: 20px;
        }
        .auth-card .card-body {
            padding: 30px;
        }

        /* Top right buttons positioning */
        .top-right-buttons {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1050;
            display: flex;
            gap: 8px;
        }

        .top-right-buttons .btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .top-right-buttons .btn:hover {
            background-color: rgba(255, 255, 255, 1);
            border-color: rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Dark mode button styles */
        body.dark-mode .top-right-buttons .btn {
            background-color: rgba(52, 58, 64, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        body.dark-mode .top-right-buttons .btn:hover {
            background-color: rgba(52, 58, 64, 1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Force auth forms to always be white, even in dark mode */
        body.dark-mode .auth-card {
            background: white !important;
            color: #212529 !important;
        }

        body.dark-mode .auth-card .card-body {
            background: white !important;
            color: #212529 !important;
        }

        body.dark-mode .auth-card .form-control {
            background-color: #fff !important;
            color: #212529 !important;
            border-color: #ced4da !important;
        }

        body.dark-mode .auth-card .form-label {
            color: #212529 !important;
        }

        body.dark-mode .auth-card .btn-link {
            color: #0d6efd !important;
        }

        body.dark-mode .auth-card .btn-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            color: white !important;
        }

        body.dark-mode .auth-card .btn-primary:hover {
            background-color: #0b5ed7 !important;
            border-color: #0a58ca !important;
        }

        body.dark-mode .auth-card .btn-success {
            background-color: #198754 !important;
            border-color: #198754 !important;
            color: white !important;
        }

        body.dark-mode .auth-card .btn-success:hover {
            background-color: #157347 !important;
            border-color: #146c43 !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function (e) {
            if (typeof Vue === 'undefined') {
                console.error('Vue.js is not loaded!');
                return;
            }
            new Vue({
                el: '#zeon',
                data: {
                    isEditing: true,
                    // Variables de autenticación
                    isAuthenticated: false,
                    currentUser: null,
                    authToken: null,
                    currentView: 'login', // 'login', 'register', 'app'
                    // Formularios de autenticación
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    registerForm: {
                        username: '',
                        password: '',
                        confirmPassword: ''
                    },
                    // Variables de estado del juego
                    turn_number: 0,
                    zeon: 0,
                    rzeon: 0,
                    act: 0,
                    rzeoni: 0,
                    zeona: 0,
                    zeonp: 0,
                    acu: false,
                    lock: 0,
                    // Listas de hechizos
                    spellBook:[],
                    readyToCast:[],
                    spellMantainList:[],
                    zeonToSpend: 0,
                    mantainZeonToSpend: 0,
                    // Formulario de hechizos
                    spellName: '',
                    spellBase: '',
                    spellInter: '',
                    spellAdvanced: '',
                    spellArcane: '',
                    spellVia: '',
                    spellBaseMantain: '',
                    spellInterMantain: '',
                    spellAdvancedMantain: '',
                    spellArcaneMantain: '',
                    // Variables de API
                    currentProfileId: null,
                    profiles: [],
                    apiBaseUrl: '',
                    loading: false,
                    error: null,
                    initialized: false,
                    // Variables de UI
                    isDarkMode: false,
                },
                beforeMount() {
                    window.addEventListener("beforeunload", this.preventNav)
                    this.$once("hook:beforeDestroy", () => {
                    window.removeEventListener("beforeunload", this.preventNav);
                    })
                },
                mounted() {
                    console.log('MOUNTED EJECUTÁNDOSE - Path:', window.location.pathname);
                    this.initialized = true;

                    // Load theme preference
                    const savedTheme = localStorage.getItem('theme');
                    this.isDarkMode = savedTheme === 'dark';
                    if (this.isDarkMode) {
                        document.body.classList.add('dark-mode');
                    }

                    // Hide initial loading screen
                    const initialLoading = document.getElementById('initial-loading');
                    if (initialLoading) {
                        initialLoading.style.display = 'none';
                    }

                    // Verificar si estamos en páginas de autenticación
                    const path = window.location.pathname;
                    console.log('Verificando path en mounted:', path);

                    if (path === '/login' || path === '/register') {
                        console.log('✅ PÁGINA DE AUTENTICACIÓN DETECTADA - NO CARGAR APP:', path);
                        this.currentView = path === '/login' ? 'login' : 'register';
                        this.clearAuthState();
                        console.log('✅ SALIENDO DE MOUNTED SIN LLAMAR INITIALIZEAUTH');
                        return; // No ejecutar initializeAuth
                    }

                    console.log('❌ PÁGINA PRINCIPAL - EJECUTANDO INITIALIZEAUTH');
                    this.initializeAuth();
                },

                beforeRouteLeave(to, from, next) {
                    if (this.isEditing) {
                    if (!window.confirm("Salir destruirá los datos introducidos")) {
                            return;
                        }
                    }
                    next();
                },
                methods: {
                    // ===== MÉTODOS DE AUTENTICACIÓN =====
                    initializeAuth() {
                        // Manejar rutas simples basadas en URL
                        const path = window.location.pathname;
                        console.log('initializeAuth() ejecutándose. Path:', path);

                        // Limpiar estado inicial para todas las rutas
                        this.clearAuthState();

                        if (path === '/register') {
                            console.log('Página de registro detectada, no cargar app');
                            this.currentView = 'register';
                            return; // No intentar autenticación automática en página de registro
                        } else if (path === '/login') {
                            console.log('Página de login detectada, no cargar app');
                            this.currentView = 'login';
                            return; // No intentar autenticación automática en página de login
                        }

                        console.log('Página principal detectada, verificar autenticación');
                        // Solo verificar token si estamos en la página principal
                        const token = localStorage.getItem('authToken');
                        const user = localStorage.getItem('currentUser');

                        if (token && user) {
                            this.validateTokenAndLogin(token, user);
                        } else {
                            // Si no hay token y estamos en la página principal, redirigir a login
                            this.currentView = 'login';
                            window.history.pushState({}, '', '/login');
                        }
                    },

                    clearAuthState() {
                        this.error = null;
                        this.loading = false;
                        this.isAuthenticated = false;
                        this.authToken = null;
                        this.currentUser = null;
                    },

                    async validateTokenAndLogin(token, user) {
                        // No ejecutar si estamos en páginas de autenticación
                        const path = window.location.pathname;
                        if (path === '/login' || path === '/register') {
                            console.log('validateTokenAndLogin() bloqueado en página de autenticación:', path);
                            return;
                        }

                        try {
                            this.authToken = token;
                            this.currentUser = JSON.parse(user);
                            this.isAuthenticated = true;
                            this.currentView = 'app';
                            window.history.pushState({}, '', '/');

                            // Intentar cargar los datos de la aplicación
                            // Si falla, significa que el token es inválido
                            await this.initializeApp();
                        } catch (error) {
                            // Token inválido o error de conexión, limpiar y mostrar login
                            console.log('Error al validar sesión:', error.message);
                            this.logout();
                        }
                    },

                    async login() {
                        try {
                            this.loading = true;
                            this.error = null;

                            const response = await this.apiCall('/auth/login', {
                                method: 'POST',
                                body: JSON.stringify(this.loginForm)
                            });

                            this.authToken = response.token;
                            this.currentUser = response.user;
                            this.isAuthenticated = true;
                            this.currentView = 'app';

                            localStorage.setItem('authToken', this.authToken);
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

                            window.history.pushState({}, '', '/');
                            await this.initializeApp();
                        } catch (error) {
                            this.error = 'Error al iniciar sesión: ' + error.message;
                        } finally {
                            this.loading = false;
                        }
                    },

                    async register() {
                        try {
                            this.loading = true;
                            this.error = null;

                            if (this.registerForm.password !== this.registerForm.confirmPassword) {
                                this.error = 'Las contraseñas no coinciden';
                                return;
                            }

                            const response = await this.apiCall('/auth/register', {
                                method: 'POST',
                                body: JSON.stringify({
                                    username: this.registerForm.username,
                                    password: this.registerForm.password
                                })
                            });

                            this.authToken = response.token;
                            this.currentUser = response.user;
                            this.isAuthenticated = true;
                            this.currentView = 'app';

                            localStorage.setItem('authToken', this.authToken);
                            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

                            window.history.pushState({}, '', '/');
                            await this.initializeApp();
                        } catch (error) {
                            this.error = 'Error al registrarse: ' + error.message;
                        } finally {
                            this.loading = false;
                        }
                    },

                    logout() {
                        this.isAuthenticated = false;
                        this.currentUser = null;
                        this.authToken = null;
                        this.currentProfileId = null;
                        this.profiles = [];
                        this.currentView = 'login';

                        // Limpiar listas temporales de hechizos (spellBook persiste)
                        this.readyToCast = [];
                        this.spellMantainList = [];

                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');

                        this.loginForm = { username: '', password: '' };
                        this.registerForm = { username: '', password: '', confirmPassword: '' };

                        window.history.pushState({}, '', '/login');
                    },

                    goToLogin() {
                        this.currentView = 'login';
                        this.error = null;
                        window.history.pushState({}, '', '/login');
                    },

                    goToRegister() {
                        this.currentView = 'register';
                        this.error = null;
                        window.history.pushState({}, '', '/register');
                    },

                    // ===== MÉTODOS DE INICIALIZACIÓN =====
                    async initializeApp() {
                        console.log('🚨 INITIALIZEAPP EJECUTÁNDOSE - Path:', window.location.pathname);

                        // No ejecutar si estamos en páginas de autenticación
                        const path = window.location.pathname;
                        if (path === '/login' || path === '/register') {
                            console.log('🛑 initializeApp() BLOQUEADO en página de autenticación:', path);
                            return;
                        }

                        console.log('▶️ CONTINUANDO CON INITIALIZEAPP EN PÁGINA PRINCIPAL');
                        try {
                            this.loading = true;
                            await this.loadProfiles();
                            if (this.profiles.length > 0) {
                                this.currentProfileId = this.profiles[0].id;
                                await this.loadGameData();
                            } else {
                                // Crear perfil por defecto si no existe
                                await this.createProfile('Jugador Principal');
                            }
                        } catch (error) {
                            console.error('Error inicializando app:', error);
                            this.error = 'Error al cargar los datos: ' + error.message;
                        } finally {
                            this.loading = false;
                        }
                    },

                    // ===== MÉTODOS DE API =====
                    async apiCall(endpoint, options = {}) {
                        const url = `${this.apiBaseUrl}/api${endpoint}`;
                        const defaultOptions = {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        };

                        if (this.authToken) {
                            defaultOptions.headers['Authorization'] = `Bearer ${this.authToken}`;
                        }

                        const response = await fetch(url, { ...defaultOptions, ...options });

                        if (!response.ok) {
                            if (response.status === 401) {
                                this.logout();
                                throw new Error('Usuario o contraseña incorrectos.');
                            }
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }

                        return response.json();
                    },

                    async loadProfiles() {
                        // No ejecutar si estamos en páginas de autenticación
                        const path = window.location.pathname;
                        if (path === '/login' || path === '/register') {
                            console.log('loadProfiles() bloqueado en página de autenticación:', path);
                            return;
                        }
                        this.profiles = await this.apiCall('/profiles');
                    },

                    async createProfile(name) {
                        const profile = await this.apiCall('/profiles', {
                            method: 'POST',
                            body: JSON.stringify({ name })
                        });
                        this.profiles.push(profile);
                        this.currentProfileId = profile.id;
                        await this.loadGameData();
                    },

                    async loadGameData() {
                        if (!this.currentProfileId) return;

                        try {
                            // Cargar estado del juego
                            const gameState = await this.apiCall(`/gamestate/${this.currentProfileId}`);
                            this.updateLocalGameState(gameState);

                            // Cargar hechizos
                            this.spellBook = await this.apiCall(`/spells/${this.currentProfileId}`);

                            // Cargar ready to cast
                            this.readyToCast = await this.apiCall(`/ready-to-cast/${this.currentProfileId}`);
                            this.updateZeonToSpend();

                            // Cargar spell mantain list
                            this.spellMantainList = await this.apiCall(`/spell-mantain/${this.currentProfileId}`);
                            this.updateMantainZeonToSpend();
                        } catch (error) {
                            console.error('Error cargando datos del juego:', error);
                        }
                    },

                    updateLocalGameState(gameState) {
                        // Usar nullish coalescing (??) en lugar de OR (||) para permitir valores 0
                        this.turn_number = gameState.turn_number ?? 0;
                        this.zeon = gameState.zeon ?? 0;
                        this.rzeon = gameState.rzeon ?? 0;
                        this.act = gameState.act ?? 0;
                        this.rzeoni = gameState.rzeoni ?? 0;
                        this.zeona = gameState.zeona ?? 0;
                        this.zeonp = gameState.zeonp ?? 0;
                        this.acu = gameState.acu ?? false;
                        this.lock = gameState.lock_state ?? 0;
                        this.zeonToSpend = gameState.zeon_to_spend ?? 0;
                        this.mantainZeonToSpend = gameState.mantain_zeon_to_spend ?? 0;
                    },

                    async saveGameState() {
                        if (!this.currentProfileId) return;

                        try {
                            await this.apiCall(`/gamestate/${this.currentProfileId}`, {
                                method: 'PUT',
                                body: JSON.stringify({
                                    turn_number: this.turn_number,
                                    zeon: this.zeon,
                                    rzeon: this.rzeon,
                                    act: this.act,
                                    rzeoni: this.rzeoni,
                                    zeona: this.zeona,
                                    zeonp: this.zeonp,
                                    acu: this.acu,
                                    lock_state: this.lock,
                                    zeon_to_spend: this.zeonToSpend,
                                    mantain_zeon_to_spend: this.mantainZeonToSpend
                                })
                            });
                        } catch (error) {
                            console.error('Error guardando estado del juego:', error);
                        }
                    },

                    // ===== MÉTODOS DE JUEGO =====
                    preventNav: function(event) {
                        if (!this.isEditing) return
                        event.preventDefault()
                        event.returnValue = ""
                    },

                    async addturn() {
                        this.turn_number++;
                        if (this.acu) {
                            if (parseInt(this.rzeon) >= parseInt(this.act)) {
                                this.zeona = parseInt(this.zeona) + parseInt(this.act);
                                this.rzeon = parseInt(this.rzeon) - parseInt(this.act);
                            } else {
                                this.zeona = parseInt(this.zeona) + parseInt(this.rzeon);
                                this.rzeon = parseInt(this.rzeon) - parseInt(this.rzeon);
                            }
                        }
                        if (this.spellMantainList.length >= 1) {
                            this.rzeon = parseInt(this.rzeon) - parseInt(this.mantainZeonToSpend);
                        }
                        await this.saveGameState();
                    },

                    async reset() {
                        this.turn_number = 0;
                        this.zeona = 0;
                        this.zeonp = 0;
                        this.zeonToSpend = 0;
                        this.readyToCast = [];
                        this.spellMantainList = [];
                        this.mantainZeonToSpend = 0;

                        // Limpiar ready to cast y mantain list en la base de datos
                        if (this.currentProfileId) {
                            try {
                                await this.apiCall(`/ready-to-cast/${this.currentProfileId}`, { method: 'DELETE' });
                                await this.saveGameState();
                            } catch (error) {
                                console.error('Error en reset:', error);
                            }
                        }
                    },

                    async addDay() {
                        const currentReserve = parseInt(this.rzeon) || 0;
                        const dailyRegen = parseInt(this.rzeoni) || 0;
                        const maxZeon = parseInt(this.zeon) || 0;

                        let newReserve = currentReserve + dailyRegen;
                        if (newReserve > maxZeon) {
                            newReserve = maxZeon;
                        }

                        this.rzeon = newReserve;
                        await this.saveGameState();
                    },

                    async lockUnlock() {
                        this.lock = (this.lock + 1) % 2;
                        this.rzeon = this.zeon;
                        await this.saveGameState();
                    },

                    // ===== MÉTODOS DE HECHIZOS =====
                    async addSpell() {
                        if (this.spellName && this.spellBase && this.spellInter && this.spellAdvanced && this.spellArcane) {
                            try {
                                const new_spell = await this.apiCall(`/spells/${this.currentProfileId}`, {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        spell_name: this.spellName,
                                        spell_base: this.spellBase,
                                        spell_inter: this.spellInter,
                                        spell_advanced: this.spellAdvanced,
                                        spell_arcane: this.spellArcane,
                                        spell_base_mantain: this.spellBaseMantain || 0,
                                        spell_inter_mantain: this.spellInterMantain || 0,
                                        spell_advanced_mantain: this.spellAdvancedMantain || 0,
                                        spell_arcane_mantain: this.spellArcaneMantain || 0,
                                        spell_via: this.spellVia
                                    })
                                });

                                this.spellBook.push(new_spell);

                                // Limpiar formulario
                                this.spellName = '';
                                this.spellBase = '';
                                this.spellInter = '';
                                this.spellAdvanced = '';
                                this.spellArcane = '';
                                this.spellBaseMantain = '';
                                this.spellInterMantain = '';
                                this.spellAdvancedMantain = '';
                                this.spellArcaneMantain = '';
                                this.spellVia = '';
                            } catch (error) {
                                console.error('Error añadiendo hechizo:', error);
                                alert("Error al añadir el hechizo");
                            }
                        } else {
                            alert("Rellena todos los campos correctamente.");
                        }
                    },

                    async removeSpell(spellName) {
                        try {
                            const spell = this.spellBook.find(s => s.spell_name === spellName);
                            if (spell) {
                                await this.apiCall(`/spells/${this.currentProfileId}/${spell.id}`, { method: 'DELETE' });
                                let i = this.spellBook.map(item => item.spell_name).indexOf(spellName);
                                this.spellBook.splice(i, 1);
                            }
                        } catch (error) {
                            console.error('Error eliminando hechizo:', error);
                        }
                    },

                    async loadSpell(loadSpellName, loadSpellZeon, loadSpellMantain) {
                        try {
                            const spell = this.spellBook.find(s => s.spell_name === loadSpellName);
                            const load_spell = await this.apiCall(`/ready-to-cast/${this.currentProfileId}`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    spell_id: spell ? spell.id : null,
                                    spell_name: loadSpellName,
                                    spell_zeon: loadSpellZeon,
                                    spell_mantain: loadSpellMantain || 0,
                                    spell_index: this.readyToCast.length
                                })
                            });

                            this.readyToCast.push({
                                id: load_spell.id,
                                spellIndex: this.readyToCast.length,
                                spellName: loadSpellName,
                                spellZeon: loadSpellZeon,
                                spellMantain: loadSpellMantain,
                                spellMantainTurn: false,
                            });

                            this.updateZeonToSpend();
                        } catch (error) {
                            console.error('Error cargando hechizo:', error);
                        }
                    },

                    async unloadSpell(unloadSpellIndex, unloadSpellZeon) {
                        try {
                            const spell = this.readyToCast.find(s => s.spellIndex === unloadSpellIndex);
                            if (spell) {
                                await this.apiCall(`/ready-to-cast/${this.currentProfileId}/${spell.id}`, { method: 'DELETE' });
                                let i = this.readyToCast.map(item => item.spellIndex).indexOf(unloadSpellIndex);
                                this.readyToCast.splice(i, 1);
                                this.updateZeonToSpend();
                            }
                        } catch (error) {
                            console.error('Error descargando hechizo:', error);
                        }
                    },

                    async unmantainSpell(unmantainSpellIndex) {
                        try {
                            const spell = this.spellMantainList.find(s => s.spell_index === unmantainSpellIndex);
                            if (spell) {
                                await this.apiCall(`/spell-mantain/${this.currentProfileId}/${spell.id}`, { method: 'DELETE' });
                                let i = this.spellMantainList.map(item => item.spell_index).indexOf(unmantainSpellIndex);
                                this.spellMantainList.splice(i, 1);
                                this.updateMantainZeonToSpend();
                            }
                        } catch (error) {
                            console.error('Error eliminando mantenimiento:', error);
                        }
                    },

                    async castSpell() {
                        try {
                            // Mantenimiento hechizos
                            const spellsToMantain = this.readyToCast.filter(entry => entry.spellMantainTurn === true);

                            for (const spell of spellsToMantain) {
                                await this.apiCall(`/spell-mantain/${this.currentProfileId}`, {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        spell_id: spell.spell_id,
                                        spell_name: spell.spellName,
                                        spell_mantain: spell.spellMantain,
                                        spell_index: this.spellMantainList.length
                                    })
                                });

                                this.spellMantainList.push({
                                    spellName: spell.spellName,
                                    spellMantain: spell.spellMantain,
                                    spellIndex: this.spellMantainList.length
                                });
                            }

                            // Gasto Zeon
                            this.zeona = parseInt(this.zeona) - parseInt(this.zeonToSpend);
                            if (parseInt(this.zeona) >= 10) {
                                this.rzeon = parseInt(this.rzeon) + (parseInt(this.zeona) - 10);
                                this.zeonp = parseInt(this.zeonp) + 10;
                                this.zeona = 0;
                            } else {
                                this.rzeon = parseInt(this.rzeon) + parseInt(this.zeona);
                                this.zeona = 0;
                            }

                            // Limpiar ready to cast
                            await this.apiCall(`/ready-to-cast/${this.currentProfileId}`, { method: 'DELETE' });
                            this.readyToCast = [];
                            this.zeonToSpend = 0;

                            this.updateMantainZeonToSpend();
                            await this.saveGameState();
                        } catch (error) {
                            console.error('Error lanzando hechizos:', error);
                        }
                    },

                    // ===== MÉTODOS AUXILIARES =====
                    updateZeonToSpend() {
                        this.zeonToSpend = this.readyToCast.reduce((total, spell) => {
                            return total + parseInt(spell.spellZeon || 0);
                        }, 0);
                    },

                    updateMantainZeonToSpend() {
                        this.mantainZeonToSpend = this.spellMantainList.reduce((total, spell) => {
                            return total + parseInt(spell.spellMantain || spell.spell_mantain || 0);
                        }, 0);
                    },

                    // ===== MÉTODOS DE UI =====
                    toggleTheme() {
                        this.isDarkMode = !this.isDarkMode;
                        document.body.classList.toggle('dark-mode');
                        localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light');
                        // Reemplazar iconos de Feather después de cambiar el tema
                        this.$nextTick(() => {
                            feather.replace();
                        });
                    }
                }
            })
        })
    </script>
</head>
<body>
    <script src="index.js"></script>

    <!-- Loading message before Vue.js initializes -->
    <div id="initial-loading" class="vue-loading">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando aplicación...</p>
        </div>
    </div>

    <div class="container-fluid" id="zeon" v-cloak :class="{ 'auth-mode': currentView === 'login' || currentView === 'register' }">

        <!-- Top right buttons container -->
        <div class="top-right-buttons" v-if="isAuthenticated">
            <!-- Theme toggle button -->
            <button @click="toggleTheme" title="Cambiar tema" type="button" class="btn btn-outline-secondary">
                <i v-if="isDarkMode" data-feather="sun"></i>
                <i v-else data-feather="moon"></i>
            </button>

            <!-- Logout button -->
            <button @click="logout" title="Cerrar sesión" type="button" class="btn btn-outline-secondary">
                <i data-feather="log-out"></i>
            </button>
        </div>

        <!-- Login Form -->
        <div v-if="currentView === 'login'" class="auth-container">
            <div class="auth-card">
                <div class="card-header">
                    <h4 class="mb-0">Iniciar Sesión</h4>
                </div>
                    <div class="card-body">
                        <form @submit.prevent="login">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label">Usuario</label>
                                <input v-model="loginForm.username" type="text" class="form-control" id="loginUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label">Contraseña</label>
                                <input v-model="loginForm.password" type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                Iniciar Sesión
                            </button>
                        </form>
                        <div class="mt-3 text-center">
                            <button @click="goToRegister" class="btn btn-link">¿No tienes cuenta? Regístrate</button>
                        </div>

                        <!-- Error message -->
                        <div v-if="error && (currentView === 'login' || currentView === 'register')" class="alert alert-danger mt-3">
                            {{ error }}
                        </div>
                    </div>
                </div>
        </div>

        <!-- Register Form -->
        <div v-if="currentView === 'register'" class="auth-container">
            <div class="auth-card">
                <div class="card-header">
                    <h4 class="mb-0">Registro</h4>
                </div>
                    <div class="card-body">
                        <form @submit.prevent="register">
                            <div class="mb-3">
                                <label for="registerUsername" class="form-label">Usuario</label>
                                <input v-model="registerForm.username" type="text" class="form-control" id="registerUsername" required>
                            </div>
                            <div class="mb-3">
                                <label for="registerPassword" class="form-label">Contraseña</label>
                                <input v-model="registerForm.password" type="password" class="form-control" id="registerPassword" required>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirmar Contraseña</label>
                                <input v-model="registerForm.confirmPassword" type="password" class="form-control" id="confirmPassword" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                                Registrarse
                            </button>
                        </form>
                        <div class="mt-3 text-center">
                            <button @click="goToLogin" class="btn btn-link">¿Ya tienes cuenta? Inicia sesión</button>
                        </div>

                        <!-- Error message -->
                        <div v-if="error && (currentView === 'login' || currentView === 'register')" class="alert alert-danger mt-3">
                            {{ error }}
                        </div>
                    </div>
                </div>
        </div>

        <!-- Main application content (only shown when authenticated) -->
        <div v-if="currentView === 'app' && isAuthenticated">
            <!-- User info -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="d-flex justify-content-start align-items-center">
                        <span>Bienvenido, {{ currentUser.displayName || currentUser.username }}</span>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div v-if="loading && currentView === 'app'" class="text-center p-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p>Cargando aplicación...</p>
            </div>

            <!-- Error indicator (solo en la aplicación, no en auth) -->
            <div v-if="error && currentView === 'app'" class="alert alert-danger" role="alert">
                {{ error }}
            </div>

            <div class="row" v-if="currentView === 'app' && !loading && !error">

            <div class="col-lg-3 col-md-6 col-12">
                <div class="card card-margin">
                    <div class="card-header">
                        Características:
                    </div>
                    <div class="list-group list-group-flush">

                        <div class="list-group-item">
                            <div class="container">
                                <div class="row">
                                    <div class="column divide">
                                        <label for="zeon">Zeon máximo: </label>
                                    </div>
                                    <div class="column d-flex align-items-center">
                                        <input v-model="zeon" @change="saveGameState" :disabled="lock == 1" class="form-control" type="number" id="zeonMaximo" name="zeon" size="10" required>
                                        <button v-on:click="lockUnlock" title="Bloquear Zeon" type="button" class="btn-add"><i data-feather="lock"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="list-group-item">
                            <div class="container">
                                <div class="row">
                                    <div class="column divide">
                                        <label for="rzeon">Reserva de Zeon: </label>
                                    </div>
                                    <div class="column divide">
                                        <input v-model="rzeon" @change="saveGameState" class="form-control" type="number" id="rzeon" name="rzeon" size="10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="list-group-item">
                            <div class="container">
                                <div class="row">
                                    <div class="column divide">
                                        <label for="act">ACT: </label>
                                    </div>
                                    <div class="column divide">
                                        <input v-model="act" @change="saveGameState" class="form-control" type="number" id="act" name="act" required size="10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="list-group-item">
                            <div class="container">
                                <div class="row">
                                    <div class="column divide">
                                        <label for="rzeoni">Reg Zeónica: </label>
                                    </div>
                                    <div class="column divide">
                                        <input v-model="rzeoni" @change="saveGameState" class="form-control" type="number" id="reg" name="reg" required size="10">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="list-group-item">
                            <button v-on:click="addDay" class="btn btn-info w-100">+1 día</button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12 col-12">

                <div class="row">

                    <div class="table-responsive card-margin">
                        <table class="table table-striped" >
                            <thead>
                            <tr>
                                <th scope="col" colspan="6" style="text-align: center;">Lista de hechizos</th>

                            </tr>
                            <tr>
                                <th scope="col">Nombre</th>
                                <th>Base</th>
                                <th>Intermedio</th>
                                <th>Avanzado</th>
                                <th>Arcano</th>
                                <th>Acción</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- AÑADIR CONJUROS -->
                            <tr v-for="item in spellBook" >
                                <th scope="row">{{ item.spell_name }}</th>

                                <td v-if="parseInt(item.spell_base) <= parseInt(zeona)"><button v-on:click="loadSpell(item.spell_name, item.spell_base, item.spell_base_mantain)" title="Cargar" type="button" class="btn btn-primary" :value="item.spell_base">{{ item.spell_base }}</button><span v-if="item.spell_base_mantain"> M: {{item.spell_base_mantain}}</span></td>
                                <td v-else title="Zeon insuficiente"><button type="button" class="btn btn-secondary" :value="item.spell_base" disabled>{{ item.spell_base }}</button><span v-if="item.spell_base_mantain"> M: {{item.spell_base_mantain}}</span></td>

                                <td v-if="parseInt(item.spell_inter) <= parseInt(zeona)"><button v-on:click="loadSpell(item.spell_name, item.spell_inter, item.spell_inter_mantain)" title="Cargar" type="button" class="btn btn-primary" :value="item.spell_inter">{{ item.spell_inter }}</button><span v-if="item.spell_inter_mantain"> M: {{item.spell_inter_mantain}}</span></td>
                                <td v-else title="Zeon insuficiente"><button type="button" class="btn btn-secondary" :value="item.spell_inter" disabled>{{ item.spell_inter }}</button><span v-if="item.spell_inter_mantain"> M: {{item.spell_inter_mantain}}</span></td>

                                <td v-if="parseInt(item.spell_advanced) <= parseInt(zeona)"><button v-on:click="loadSpell(item.spell_name, item.spell_advanced, item.spell_advanced_mantain)" title="Cargar" type="button" class="btn btn-primary" :value="item.spell_advanced">{{ item.spell_advanced }}</button><span v-if="item.spell_advanced_mantain"> M: {{item.spell_advanced_mantain}}</span></td>
                                <td v-else title="Zeon insuficiente"><button type="button" class="btn btn-secondary" :value="item.spell_advanced" disabled>{{ item.spell_advanced }}</button><span v-if="item.spell_advanced_mantain"> M: {{item.spell_advanced_mantain}}</span></td>

                                <td v-if="parseInt(item.spell_arcane) <= parseInt(zeona)"><button v-on:click="loadSpell(item.spell_name, item.spell_arcane, item.spell_arcane_mantain)" title="Cargar" type="button" class="btn btn-primary" :value="item.spell_arcane">{{ item.spell_arcane }}</button><span v-if="item.spell_arcane_mantain"> M: {{item.spell_arcane_mantain}}</span></td>
                                <td v-else title="Zeon insuficiente"><button type="button" class="btn btn-secondary" :value="item.spell_arcane" disabled>{{ item.spell_arcane }}</button><span v-if="item.spell_arcane_mantain"> M: {{item.spell_arcane_mantain}}</span></td>

                                <td><button type="button" v-on:click="removeSpell(item.spell_name)" class="btn-add" title="Eliminar"><i data-feather="x-circle" class="text-danger-icon"></i></button></td>
                            </tr>
                            <tr>
                                <th scope="row"><input v-model="spellName" placeholder="Hechizo" class="form-control" type="text" id="name" name="name" size="10" required></th>
                                <td>
                                    <input v-model="spellBase" title="Zeon" placeholder="60" class="form-control zeon-mantain" type="number" id="base" name="base" size="2" required>
                                    <input v-model="spellBaseMantain" title="Mantenimiento" placeholder="10" class="form-control zeon-mantain" type="number" id="basemantain" name="basemantain" size="2">
                                </td>
                                <td>
                                    <input v-model="spellInter" title="Zeon" placeholder="100" class="form-control zeon-mantain" type="number" id="inter" name="inter" size="2" required>
                                    <input v-model="spellInterMantain" title="Mantenimiento" placeholder="10" class="form-control zeon-mantain" type="number" id="intermantain" name="basemantain" size="2">
                                </td>
                                <td>
                                    <input v-model="spellAdvanced" title="Zeon" placeholder="150" class="form-control zeon-mantain" type="number" id="advanced" name="advanced" size="2" required>
                                    <input v-model="spellAdvancedMantain" title="Mantenimiento" placeholder="15" class="form-control zeon-mantain" type="number" id="advancedmantain" name="basemantain" size="2">
                                </td>
                                <td>
                                    <input v-model="spellArcane" title="Zeon" placeholder="250" class="form-control zeon-mantain" type="number" id="arcane" name="arcane" size="2" required>
                                    <input v-model="spellArcaneMantain" title="Mantenimiento" placeholder="25" class="form-control zeon-mantain" type="number" id="arcanemantain" name="arcanemantain" size="2">
                                </td>
                                <td><button type="button" v-on:click="addSpell" class="btn-add" title="Añadir"><i data-feather="plus-circle" class="text-success-icon"></i></button></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>

            <div class="col-lg-3 col-md-6 col-12">

                <div class="row">
                    <div class="card card-margin">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item">
                                <div id="turn" class="row">
                                    <div class="col-6 d-flex align-items-center justify-content-center">
                                        <div>
                                            <h2 class="turn-title">Turno: {{turn_number}}</h2>
                                        </div>
                                    </div>
                                    <div class="col-3 d-flex align-items-center">
                                        <button v-on:click="addturn" title="Pasar turno" id="add-turn" type="button" class="btn btn-success">+1</button>
                                    </div>
                                    <div class="col-3 d-flex align-items-center">
                                        <button v-on:click="reset" title="Reiniciar turno" type="button" class="btn btn-danger">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card card-margin">
                        <div class="list-group list-group-flush">

                            <div class="list-group-item">
                                <div class="container">
                                    <div class="row">
                                        <div class="column">
                                            <label for="zeona">Zeon acumulado: </label>
                                        </div>
                                        <div class="column">
                                            <input v-model="zeona" @change="saveGameState" class="form-control" type="number" id="zeona" name="zeona" required size="10">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group-item">
                                <div class="container">
                                    <div class="row">
                                        <div class="column">
                                            <label for="zeonp">Zeon perdido: </label>
                                        </div>
                                        <div class="column">
                                            <input v-model="zeonp" @change="saveGameState" class="form-control" type="number" id="zeonp" name="zeonp" required size="10">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="list-group-item">
                                <div class="container">
                                    <div class="row">
                                        <div class="column divide col-sm">
                                            <label for="acu">Acumular: </label>
                                        </div>
                                        <div class="column divide col-sm">
                                            <input v-model="acu" @change="saveGameState" class="form-check-input" type="checkbox" id="acu" name="acu">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div>
                        <table class="table">
                            <thead>
                                <tr><th scope="col" colspan="4" style="text-align: center;">Hechizos a lanzar:</th></tr>
                                <tr>
                                  <th scope="col">Nombre</th>
                                  <th scope="col">Zeon</th>
                                  <th scope="col">Mantener</th>
                                  <th scope="col">Quitar</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr  v-for="item in readyToCast">
                                  <th scope="row">{{ item.spellName }}</th>
                                  <td>{{ item.spellZeon }}</td>
                                  <td v-if="item.spellMantain"><input v-model="item.spellMantainTurn" title="Mantener" class="form-check-input" type="checkbox" id="mantain" name="mantain" size="2"> <span>/ {{item.spellMantain}}</span></td>
                                  <td v-else><input v-model="item.spellMantainTurn" title="Mantener" class="form-check-input" type="checkbox" id="mantain" name="mantain" size="2" disabled></td>
                                  <td><button class="btn-add" type="button" v-on:click="unloadSpell(item.spellIndex, item.spellZeon)" title="Eliminar"><i data-feather="trash-2" class="text-danger-icon"></i></button></td>
                                </tr>
                                <tr v-if="parseInt(this.zeonToSpend) <= parseInt(this.zeona)">
                                    <th scope="row">Total: </th>
                                    <td colspan="3"><input v-model="zeonToSpend" title="ZeonToSpend" class="form-control" type="number" size="2"></td>
                                </tr>
                                <tr v-else>
                                    <th scope="row" style="color:#9b0000">Total: </th>
                                    <td colspan="3" style="color:#9b0000"><input v-model="zeonToSpend" title="ZeonToSpend" class="form-control" type="number" size="2"></td>
                                </tr>
                                <tr v-if="parseInt(this.zeonToSpend) <= parseInt(this.zeona)">
                                    <th scope="row" colspan="4"><button v-on:click="castSpell()" class="btn btn-primary w-100">Lanzar</button></th>
                                </tr>
                                <tr v-else>
                                    <th scope="row" colspan="4" title="Zeon insuficiente"><button class="btn btn-primary w-100" disabled>Lanzar</button></th>
                                </tr>
                              </tbody>
                        </table>
                    </div>
                    <div v-if="this.spellMantainList.length >= 1">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col" colspan="3" style="text-align: center;">Hechizos mantenidos:</th>
                                </tr>
                                <tr>
                                  <th scope="col">Nombre</th>
                                  <th scope="col">Zeon / turno</th>
                                  <th scope="col">Dejar de mantener</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr  v-for="item in spellMantainList">
                                  <th scope="row">{{ item.spellName || item.spell_name }}</th>
                                  <td>{{ item.spellMantain || item.spell_mantain }}</td>
                                  <td><button class="btn-add" type="button" v-on:click="unmantainSpell(item.spellIndex || item.spell_index)" title="Eliminar"><i data-feather="trash-2" class="text-danger-icon"></i></button></td>
                                </tr>
                                <tr>
                                    <th scope="row">Zeon / turno: </th>
                                    <td colspan="3">{{ this.mantainZeonToSpend }}</td>
                                </tr>
                              </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>

        </div> <!-- End of v-if="isAuthenticated" -->

    </div>

    <script>
        feather.replace()
    </script>
</body>
</html>